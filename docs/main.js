(()=>{"use strict";var __webpack_modules__={22:(e,t,r)=>{function n(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function a(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function o(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?a(r,!0).forEach((function(t){n(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):a(r).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function i(e){return function(e){if(Array.isArray(e)){for(var t=0,r=new Array(e.length);t<e.length;t++)r[t]=e[t];return r}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}r.d(t,{$:()=>u});var s={name:"fill",regex:/^[^]/,getValue:function(e){return e}};function c(e){for(var t=e.source,r=void 0===t?"":t,n=e.rules,a=[];r.length>0;){var o=!0,c=!1,l=void 0;try{for(var u,p=n[Symbol.iterator]();!(o=(u=p.next()).done);o=!0){var f=u.value,h=r.match(f.regex);if(h){f===s&&a.length>0&&a[a.length-1].name===s.name?a[a.length-1].value+=f.getValue.apply(f,i(h)):a.push({name:f.name,value:f.getValue.apply(f,i(h))}),r=r.substr(h[0].length);break}}}catch(e){c=!0,l=e}finally{try{o||null==p.return||p.return()}finally{if(c)throw l}}}return a}function l(e){if(0===e.length)throw new Error("Must define at least one rule");e.forEach((function(e){if(!e.name)throw new Error("All rules must have `name`, a string indicating the type of token");if(!e.regex)throw new Error("All rules must have `regex`, a string containing the token regex");if(!e.getValue)throw new Error("All rules must have `getValue`, a function which, provided the regex match, returns the token value")}))}function u(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return l(e),(e=e.map((function(e){return o({},e,{regex:new RegExp("^".concat(e.regex))})}))).push(s),function(t){return c({source:t,rules:e})}}},201:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{Z:()=>__WEBPACK_DEFAULT_EXPORT__});var lil_lexer__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(22);function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function ownKeys(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function _objectSpread2(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(r),!0).forEach((function(t){_defineProperty(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):ownKeys(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function _taggedTemplateLiteral(e,t){return t||(t=e.slice(0)),Object.freeze(Object.defineProperties(e,{raw:{value:Object.freeze(t)}}))}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _iterableToArrayLimit(e,t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e)){var r=[],n=!0,a=!1,o=void 0;try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){a=!0,o=e}finally{try{n||null==s.return||s.return()}finally{if(a)throw o}}return r}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _createForOfIteratorHelper(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==r.return||r.return()}finally{if(s)throw o}}}}function parse(e){var t,r=[],n=[r],a=_createForOfIteratorHelper(e);try{for(a.s();!(t=a.n()).done;){var o=t.value;switch(o.name){case"if":var i={name:"condition",value:[{condition:o.value,branch:[]}]};n[n.length-1].push(i),n.push(i.value),n.push(i.value[0].branch);break;case"elseif":var s={condition:o.value,branch:[]};n.pop(),n[n.length-1].push(s),n.push(s.branch);break;case"endif":if(n.length<3)throw new Error("Tried to close if block, but one wasn't open");n.pop(),n.pop();break;case"action":case"do":case"print":n[n.length-1].push(o);break;case"fill":var c=_objectSpread2(_objectSpread2({},o),{},{name:"text"});n[n.length-1].push(c);break;case"comment":break;default:throw new Error("Unrecognized token name: ".concat(o.name))}}}catch(e){a.e(e)}finally{a.f()}if(1!==n.length)throw new Error("Unclosed stack: ".concat(n));return r}function _templateObject9(){var e=_taggedTemplateLiteral(["<<s*?prints*?([^]+?)s*?>>"],["<<\\s*?print\\s*?([^]+?)\\s*?>>"]);return _templateObject9=function(){return e},e}function _templateObject8(){var e=_taggedTemplateLiteral(["<<s*?sets*?([^]+?)s*?=([^]+?)s*?>>"],["<<\\s*?set\\s*?([^]+?)\\s*?=([^]+?)\\s*?>>"]);return _templateObject8=function(){return e},e}function _templateObject7(){var e=_taggedTemplateLiteral(["<<s*?dos*?([^]+?)s*?>>"],["<<\\s*?do\\s*?([^]+?)\\s*?>>"]);return _templateObject7=function(){return e},e}function _templateObject6(){var e=_taggedTemplateLiteral(["<<s*?endifs*?>>"],["<<\\s*?endif\\s*?>>"]);return _templateObject6=function(){return e},e}function _templateObject5(){var e=_taggedTemplateLiteral(["<<s*?else?s*?>>"],["<<\\s*?else?\\s*?>>"]);return _templateObject5=function(){return e},e}function _templateObject4(){var e=_taggedTemplateLiteral(["<<s*?els?e?s*?ifs*?([^]+?)s*?>>"],["<<\\s*?els?e?\\s*?if\\s*?([^]+?)\\s*?>>"]);return _templateObject4=function(){return e},e}function _templateObject3(){var e=_taggedTemplateLiteral(["<<s*?ifs*?([^]+?)s*?>>"],["<<\\s*?if\\s*?([^]+?)\\s*?>>"]);return _templateObject3=function(){return e},e}function _templateObject2(){var e=_taggedTemplateLiteral(["[[([^]+?)]]"],["\\[\\[([^]+?)\\]\\]"]);return _templateObject2=function(){return e},e}function _templateObject(){var e=_taggedTemplateLiteral(["//(.*)\n?"],["\\/\\/(.*)\\n?"]);return _templateObject=function(){return e},e}var lexicon=[{name:"comment",regex:String.raw(_templateObject()),getValue:function(e,t){return t.trim()}},{name:"action",regex:String.raw(_templateObject2()),getValue:function(e,t){var r=_slicedToArray(t.split("|"),2),n=r[0];return{text:n,action:r[1]||'this.goto("'.concat(n.replace(/"/g,'\\"'),'")')}}},{name:"if",regex:String.raw(_templateObject3()),getValue:function(e,t){return t.trim()}},{name:"elseif",regex:String.raw(_templateObject4()),getValue:function(e,t){return t.trim()}},{name:"elseif",regex:String.raw(_templateObject5()),getValue:function(){return"true"}},{name:"endif",regex:String.raw(_templateObject6()),getValue:function(){}},{name:"do",regex:String.raw(_templateObject7()),getValue:function(e,t){return t.trim()}},{name:"do",regex:String.raw(_templateObject8()),getValue:function(e,t,r){return"this.".concat(t.trim(),"=").concat(r.trim())}},{name:"print",regex:String.raw(_templateObject9()),getValue:function(e,t){return t.trim()}}],lex=(0,lil_lexer__WEBPACK_IMPORTED_MODULE_0__.$)(lexicon);function compile(e){return parse(lex(e))}function parsePassages(e){var t=(e=e.replace(/[\r]/g,"").trim()).split(/^:{2}(.+)\n/gm);if(t.shift().length>0&&console.warn("Found text above first passage title; this text will be ignored"),0===t.length)throw new Error("No passages found");for(var r={},n=0;n<t.length;n+=2){var a=t[n],o=t[n+1].trim();if(0===o.length)throw new Error('Passage titled "'.concat(a,'" is empty"'));if(r[a])throw new Error('Multiple passages titled "'.concat(a,'" found'));r[a]={title:a,body:o}}return r}function compilePassage(e){if(!e)throw new Error("No passage provided");var t=e.title,r=e.body;if(!t)throw new Error("Passage must have a title");if(!r)throw new Error("Passage must have a body");return _objectSpread2(_objectSpread2({},e),{},{program:compile(e.body)})}var defaultTitle="DEFAULT",defaultPassage={title:defaultTitle,body:"This shows up when a passage failed to parse, or doesn't even exist. Try checking the link for spelling errors or the console logs for more detail on the error.\n[[back|this.back();]]"},_default=function(){function _default(_ref){var renderer=_ref.renderer,source=_ref.source;if(_classCallCheck(this,_default),"function"!=typeof renderer.displayPassage)throw new Error("renderer must have a `displayPassage` function which accepts a parsed passage and returns a Promise");this.history=[],this.currentPassage=null,this._evalInScope=function(script){return eval(script)}.bind(this),this.busy=!1,this.renderer=renderer,this.setSource(source)}return _createClass(_default,[{key:"eval",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return console.log("Running script:",e),this._evalInScope(e)}},{key:"setSource",value:function(e){this.passages=e?parsePassages(e):{},this.passages[defaultTitle]=this.passages[defaultTitle]||defaultPassage}},{key:"getPassageWithTitle",value:function(e){try{if(!this.passages[e])throw new Error('Passage titled "'.concat(e,'" not found"'));return compilePassage(this.passages[e])}catch(t){return console.error('Failed to parse passage titled "'.concat(e,'", going to "').concat(defaultTitle,'" instead. Original error:'),t),compilePassage(this.passages[defaultTitle])}}},{key:"goto",value:function(e){var t=this;return console.log("Going to passage:",e),Promise.resolve().then((function(){return t.getPassageWithTitle(e)})).then((function(e){return t.displayPassage(e)}))}},{key:"back",value:function(){var e=this;if(console.log("back"),0===this.history.length)return Promise.reject(new Error("Cannot go back because there is no history available."));var t=this.history.pop();return this.goto(t).then((function(){return e.history.pop(),t}))}},{key:"displayPassage",value:function(e){var t=this;if(this.busy)throw new Error("Busy waiting for previous passage to display; cannot display another");return console.log("Displaying passage:",e),this.currentPassage?this.history.push(this.currentPassage.title):console.warn("No history pushed because there is no current passage"),this.currentPassage=e,this.busy=!0,this.renderer.displayPassage(e).then((function(){t.busy=!1}))}},{key:"execute",value:function(e){var t=this;return e.reduce((function(e,r){switch(r.name){case"condition":var n,a=_createForOfIteratorHelper(r.value);try{for(a.s();!(n=a.n()).done;){var o=n.value,i=void 0;try{i=t.eval(o.condition)}catch(t){console.error("Failed to evaluate condition",o,t),e.push({name:"text",value:"Failed to evaluate condition:\n".concat(o.condition,"\n").concat(t.message)});continue}if(i){e=e.concat(t.execute(o.branch));break}}}catch(e){a.e(e)}finally{a.f()}break;case"do":try{t.eval(r.value)}catch(t){console.error("Failed to evaluate node",r,t),e.push({name:"text",value:"Failed to evaluate node:\n".concat(r.value,"\n").concat(t.message)})}break;case"print":e.push({name:"text",value:t.eval(r.value)});break;default:e.push(r)}return e}),[])}}]),_default}();const __WEBPACK_DEFAULT_EXPORT__=_default}},__webpack_module_cache__={};function __webpack_require__(e){var t=__webpack_module_cache__[e];if(void 0!==t)return t.exports;var r=__webpack_module_cache__[e]={exports:{}};return __webpack_modules__[e](r,r.exports,__webpack_require__),r.exports}__webpack_require__.d=(e,t)=>{for(var r in t)__webpack_require__.o(t,r)&&!__webpack_require__.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},__webpack_require__.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var __webpack_exports__={};(()=>{var e=__webpack_require__(201);const t=new class{constructor(t){this.strand=new e.Z({renderer:this,source:t}),this.strand.goto("start")}preprocessText(e){return String(e).replace(/\n/g,"<br>")}displayPassage(e){document.body.innerHTML="";const t=document.createElement("section"),r=document.createElement("pre");r.innerText=e.body,t.appendChild(r);const n=document.createElement("section"),a=this.strand.execute(e.program);for(let e of a)switch(e.name){case"text":const t=document.createElement("span");t.innerHTML=this.preprocessText(e.value),n.appendChild(t);break;case"action":const r=document.createElement("a");r.innerHTML=this.preprocessText(e.value.text),r.href="#",r.onclick=()=>{this.strand.eval(e.value.action)},n.appendChild(r);break;default:throw new Error(`Unrecognized program node type: ${e.name}`)}return document.body.appendChild(n),document.body.appendChild(document.createElement("br")),document.body.appendChild(t),Promise.resolve()}}('::start\r\nsome text with a [[shorthand link]] and a longform [[action|this.goto("other passage")]]\r\n\r\n::shorthand link\r\n<<set linkClicked=true>>this passage appears when you click the link\r\n[[back|this.back()]]\r\n\r\n::other passage\r\nthis.linkClicked = <<print this.linkClicked>>\r\n<<if this.linkClicked>>\r\nthis text shows up if you visited the shorthand link passage before getting here\r\n<<else>>\r\nthis text shows up if you didn\'t\r\n<<endif>>\r\n[[back|this.back()]]');window.renderer=t})()})();